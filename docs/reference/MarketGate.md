# Market Gate (시장 상태 분석)

**파일**: `market_gate.py` → `run_kr_market_gate()`

**분석 지표**:
**분석 지표 (Total 100점)**:
| 카테고리 | 지표         | 배점 | 설명                |
| :------- | :----------- | :--- | :------------------ |
| **Tech** | 추세 정렬    | 25점 | 20MA > 60MA 정배열  |
| **Tech** | RSI          | 25점 | 50-70 구간 최적     |
| **Tech** | MACD         | 20점 | 골든크로스 여부     |
| **Tech** | 거래량       | 15점 | 20일 평균 상회      |
| **Tech** | 상대강도(RS) | 15점 | KOSPI 대비 초과수익 |

**섹터 ETF 분석 (KODEX 위주 구성)**:

sectors = {
    '반도체': '091160',      # KODEX 반도체
    '2차전지': '305720',     # TIGER 2차전지테마
    '자동차': '091170',      # KODEX 자동차
    '헬스케어': '102780',    # KODEX 헬스케어
    'IT': '091180',          # TIGER 200 IT
    '은행': '102960',        # KODEX 은행
    '철강': '117680',        # TIGER 200 철강소재
    '증권': '102970',        # KODEX 증권
    '조선': '446910',        # KODEX 조선 (추가)
    '에너지': '117690',      # KODEX 에너지화학 (추가)
    'KOSPI 200': '069500'    # KODEX 200
}

---

## 1. 주식 기술적 분석 시그널 판정 체계

### 1. 트렌드 정렬 (최대 25점)
| 조건                                | 점수  |
| :---------------------------------- | :---- |
| 현재가 > 20일 MA > 60일 MA (정배열) | +25점 |
| 현재가 > 20일 MA                    | +15점 |
| 현재가 > 60일 MA                    | +10점 |
| 모두 미충족 (하락추세)              | 0점   |

### 2. RSI (최대 25점)
| RSI 범위 | 점수  | 해석             |
| :------- | :---- | :--------------- |
| 50 ~ 70  | +25점 | 상승 구간        |
| 40 ~ 50  | +15점 | 중립             |
| 30 ~ 40  | +20점 | 과매도 반등 기대 |
| < 30     | +10점 | 심한 과매도      |

### 3. MACD (최대 20점)
| 조건                            | 점수  |
| :------------------------------ | :---- |
| MACD > Signal Line (골든크로스) | +20점 |
| MACD < Signal Line              | 0점   |

### 4. 거래량 (최대 15점)
| 거래량 비율 (20일 평균 대비) | 점수  |
| :--------------------------- | :---- |
| > 1.2배 (활발)               | +15점 |
| 0.8 ~ 1.2배                  | +10점 |
| < 0.8배 (저조)               | 0점   |

### 5. 상대강도 vs KOSPI (최대 15점)
| RS (20일 수익률 - KOSPI 수익률) | 점수  |
| :------------------------------ | :---- |
| > 2% (KOSPI 대비 아웃퍼폼)      | +15점 |
| 0 ~ 2%                          | +10점 |
| -2 ~ 0%                         | +5점  |
| < -2% (언더퍼폼)                | 0점   |

### 🚦 시그널 판정 (최종 합계)
| 점수        | 시그널             |
| :---------- | :----------------- |
| **≥ 70**    | **Bullish (초록)** |
| **40 ~ 69** | **Neutral (노랑)** |
| **< 40**    | **Bearish (빨강)** |

### 🔍 평가 로직 상세 (Technical System)

**1. 기술적 지표 (100점)**
- **추세 (25점)**: 20MA > 60MA (정배열)
- **RSI (25점)**: RSI 50 ~ 70 구간
- **MACD (20점)**: MACD > Signal Line (골든크로스)
- **거래량 (15점)**: 당일 거래량 > 20일 평균 거래량
- **상대강도 (15점)**: KOSPI 대비 수익률 (RS)


---

## 📊 분석 엔진 상세

### 1. VCP (Volatility Contraction Pattern) 분석

**파일**: `screener.py` → `SmartMoneyScreener._detect_vcp_pattern()`

**VCP 점수 (Total 100점, 50점 이상 합격)**:
| 항목 | 배점 | 상세 기준 |
| :--- | :--- | :-------- |
### 1. VCP (Volatility Contraction Pattern) 분석

**파일**: `screener.py` → `SmartMoneyScreener.detect_vcp_pattern()`

**VCP 점수 (Total 10점)**:
- 기존 100점 만점 VCP 점수를 10점 만점으로 환산하여 적용
- (변동성 축소 + 거래량 건조 + 이평선 정배열) / 10

---

### 2. 수급 분석 (Smart Money Tracking)

**파일**: `screener.py` → `SmartMoneyScreener.analyze_stock()`

**분석 가중치 (총 100점)**:
| 항목               | 가중치 | 설명               |
| ------------------ | ------ | ------------------ |
| 외국인 순매매량    | 25점   | 5일/20일/60일 누적 |
| 외국인 연속 매수일 | 15점   | 연속 순매수 일수   |
| 기관 순매매량      | 20점   | 5일/20일/60일 누적 |
| 기관 연속 매수일   | 10점   | 연속 순매수 일수   |
| 거래량 대비 비율   | 20점   | 수급 강도          |
| VCP 패턴           | 10점   | 변동성 수축 패턴   |

**데이터 소스 우선순위**:
1. **pykrx** - KRX 공식 데이터
2. **FinanceDataReader** - 네이버 금융 크롤링
3. **yfinance** - Yahoo Finance API

---

### 3. 종가베팅 점수 시스템

**파일**: `engine/scorer.py` → `Scorer.calculate()`

#### 📊 통합 등급 산정 기준 <p align="right">※ 거래대금 500억 미만 자동 제외</p>

|  등급   | 거래대금 & 등락률          | 점수 (Total / 21) | 추가 조건 (거래량/수급)               | 비고             |
| :-----: | :------------------------- | :---------------: | :------------------------------------ | :--------------- |
| **S급** | **1조원 이상**, +10% 이상  |   **10점 이상**   | 거래량 **5배↑**, 외인+기관 **양매수** | 초대형 수급 폭발 |
| **A급** | **5,000억 이상**, +5% 이상 |   **8점 이상**    | 거래량 **3배↑**, 외인 or 기관         | 대형 우량주      |
| **B급** | **1,000억 이상**, +4% 이상 |   **6점 이상**    | 거래량 **2배↑**, 외인 or 기관         | 중형 주도주      |
| **C급** | **500억 이상**, +5% 이상   |   **8점 이상**    | 거래량 **3배↑**, 외인+기관 **양매수** | 강소 주도주      |

> [!NOTE]
> **등급 판정 우선순위**: S급 → A급 → B급 → C급 순으로 판정하며, 상위 등급 조건을 만족하면 해당 등급이 부여됩니다.
    
**E. 종합 점수 산정 기준 (Scoring Logic - Max 21점)**

등급 산정에 사용되는 **'종합 점수(Total Score)'**는 **기본 점수(12점)**와 **가산점(9점)**의 합산입니다.

#### 🎯 핵심 평가 요소 (Score 21점 만점)

**1. 기본 배점 항목 (Max 12점)**
| 항목            |  배점   | 상세 기준                                      | 평가 목적           |
| :-------------- | :-----: | :--------------------------------------------- | :------------------ |
| **📰 뉴스/재료** | **3점** | AI 기사 분석 및 강도 평가 (Fallback: 거래대금) | 재료의 지속성 판단  |
| **💰 거래대금**  | **3점** | 1조(3점), 5000억(2점), 1000억(1점)             | 시장 주도력 평가    |
| **📈 차트 패턴** | **2점** | 52주 신고가 돌파(+1), 이평선 정배열(+1)        | 기술적 추세 확인    |
| **🤝 수급**      | **2점** | 외인 순매수(+1), 기관 순매수(+1)               | 메이저 자금 유입    |
| **🕯️ 캔들 형태** | **1점** | 장대양봉 및 윗꼬리 관리 (몸통 > 꼬리×2)        | 매수 세력 강도      |
| **⏱️ 기간조정**  | **1점** | **볼린저밴드 수축 및 횡보 후 돌파**            | 에너지 응축 후 발산 |

**2. 가산점 항목 (Max 9점)**
| 항목              |   배점   | 상세 조건                                       |
| :---------------- | :------: | :---------------------------------------------- |
| **📊 거래량 급증** | **+4점** | 10배↑(+4), 5배↑(+3), 3배↑(+2), 2배↑(+1)         |
| **🚀 당일 상승률** | **+5점** | 25%↑(+5), 20%↑(+4), 15%↑(+3), 10%↑(+2), 5%↑(+1) |

#### 📋 점수별 의미

```
┌─────────────────────────────────────────────────────────────┐
│  18~21점   │  최강 주도주 (기본 만점 + 가산점 대량 획득)     │
│  13~17점   │  강력 주도주 (기본 고득점 + 가산점 포함)        │
│  8~12점    │  우량 시그널 (전통적인 수급/차트 우량주)        │
│  6~7점     │  관망/조건부 (B급 최소 요건 또는 C급 하위)      │
│  5점 이하  │  등급 미달 (시그널 제외)                        │
└─────────────────────────────────────────────────────────────┘
```

> [!WARNING]
> **점수만으로는 등급이 결정되지 않습니다.** 거래대금, 등락률, 거래량배수, 수급 조건을 **모두 만족**해야 해당 등급이 부여됩니다.
> 
> 예시: 점수 10점이라도 거래대금이 500억이면 S급이 아닌 C급이 됩니다.